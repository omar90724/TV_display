<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Gestor de Conte√∫do - Digital Signage</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background: #f4f7f6; color: #333; }
        .nav { margin-bottom: 25px; display: flex; gap: 20px; }
        .nav a { text-decoration: none; color: #007bff; font-weight: 600; border: 1px solid #007bff; padding: 8px 15px; border-radius: 5px; transition: 0.3s; }
        .nav a:hover { background: #007bff; color: white; }
        
        form { background: #fff; padding: 25px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #e0e0e0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        input, select, label { display: block; width: 100%; max-width: 450px; margin: 8px 0; padding: 12px; border-radius: 6px; box-sizing: border-box; }
        input, select { border: 1px solid #ccd1d9; outline-color: #007bff; }

        h2 { border-left: 5px solid #007bff; padding-left: 15px; margin-top: 40px; font-size: 1.4rem; color: #2c3e50; }
        
        .media-list { display: flex; flex-wrap: wrap; gap: 20px; background: #eef1f5; padding: 20px; border-radius: 12px; min-height: 150px; margin-top: 15px; }
        .history-list { background: #dcdde1; border: 2px dashed #bdc3c7; }

        .media-item { background: #fff; width: 240px; padding: 15px; border-radius: 12px; cursor: grab; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: transform 0.2s; }
        .media-item:active { transform: scale(1.02); }
        .media-item video, .media-item img { width: 100%; height: 130px; object-fit: cover; background: #000; border-radius: 8px; }
        
        /* Tags Traduzidas */
        .media-tag { display: inline-block; padding: 4px 10px; border-radius: 4px; color: white; font-size: 11px; font-weight: bold; margin-bottom: 10px; }
        .tag-image { background: #007bff; }   /* Azul - IMAGEM */
        .tag-video { background: #e74c3c; }   /* Vermelho - V√çDEO */
        .tag-url { background: #9b59b6; }     /* Roxo - SITE */
        .tag-powerbi { background: #f1c40f; color: #2c3e50; } /* Amarelo - POWER BI */

        .expiry-info { font-size: 11px; color: #7f8c8d; margin-top: 12px; padding: 8px; background: #f9f9f9; border-radius: 6px; border: 1px solid #ecf0f1; }
        .expiry-expired { background: #fdf2f2; border-color: #fad2d2; color: #c0392b; font-weight: bold; }
        
        .btn-group { display: flex; gap: 8px; margin-top: 15px; }
        .delete-btn { background: #fdfdfd; color: #7f8c8d; border: 1px solid #dcdde1; flex: 1; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 12px; }
        .delete-btn:hover { background: #e74c3c; color: white; border-color: #e74c3c; }
        .edit-btn { background: #f39c12; color: white; border: none; flex: 1; padding: 8px; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 12px; }
        
        .save-btn { margin-top: 25px; padding: 15px 40px; background: #27ae60; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3); }
        .save-btn:hover { background: #2ecc71; }
    </style>
</head>
<body>
    <div class="nav">
        <a href="index.html">‚¨ÖÔ∏è Painel Central</a>
        <a href="#" id="playerLink" target="_blank">üì∫ Abrir TV</a>
    </div>

    <h1>Gerir TV: <span id="tvTitle" style="color:#007bff"></span></h1>

    <form id="uploadForm">
        <label>Tipo de M√≠dia:</label>
        <select name="type" id="typeSelect" onchange="toggleFields()">
            <option value="image">Imagem Local</option>
            <option value="video">V√≠deo Local</option>
            <option value="url">Site / Link Externo</option>
            <option value="powerbi">Relat√≥rio Power BI</option>
        </select>
        
        <input type="file" name="file" id="fileIn">
        <input type="text" name="url" id="urlIn" placeholder="Cole aqui o URL do site ou o ID do Relat√≥rio" style="display:none">
        <input type="text" name="pageName" id="pageIn" placeholder="Nome da Aba (ex: ReportSection1)" style="display:none">
        
        <label>Dura√ß√£o (segundos):</label>
        <input type="number" name="displayDuration" value="15" min="1">
        
        <label>Data de Expira√ß√£o:</label>
        <input type="datetime-local" name="expirationDateTime" required>
        
        <button type="submit">‚ûï Adicionar √† Playlist</button>
    </form>

    <div class="section-title">
        <h2>‚ñ∂Ô∏è Playlist Ativa</h2>
        <p style="font-size: 0.9rem; color: #7f8c8d;">Arraste para reordenar o que aparece na TV.</p>
    </div>
    <div id="mediaList" class="media-list"></div>
    <button onclick="saveOrder()" class="save-btn">üíæ Salvar Nova Ordem</button>

    <div class="section-title">
        <h2>üìú Hist√≥rico (Conte√∫do Expirado)</h2>
        <p style="font-size: 0.9rem; color: #7f8c8d;">M√≠dias que sa√≠ram do ar. Altere a data para reativar.</p>
    </div>
    <div id="historyList" class="media-list history-list"></div>

    <script>
        const playerId = new URLSearchParams(window.location.search).get('id');
        document.getElementById('tvTitle').innerText = playerId;
        document.getElementById('playerLink').href = `player.html?id=${playerId}`;

        function toggleFields() {
            const val = document.getElementById('typeSelect').value;
            document.getElementById('fileIn').style.display = (val === 'image' || val === 'video') ? 'block' : 'none';
            document.getElementById('urlIn').style.display = (val === 'url' || val === 'powerbi') ? 'block' : 'none';
            document.getElementById('pageIn').style.display = (val === 'powerbi') ? 'block' : 'none';
        }

        function getStatus(timestamp) {
            const date = new Date(timestamp);
            const expired = date < new Date();
            return { 
                text: date.toLocaleString('pt-PT', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }), 
                expired 
            };
        }

        async function load() {
            const res = await fetch(`/api/media/${playerId}`);
            const data = await res.json();
            
            const activeContainer = document.getElementById('mediaList');
            const historyContainer = document.getElementById('historyList');
            activeContainer.innerHTML = '';
            historyContainer.innerHTML = '';

            data.forEach(m => {
                const status = getStatus(m.expiresAt);
                
                // TRADU√á√ÉO DAS TAGS AQUI
                let label = m.type.toUpperCase();
                if(m.type === 'image') label = 'IMAGEM';
                if(m.type === 'video') label = 'V√çDEO';
                if(m.type === 'url') label = 'SITE';
                if(m.type === 'powerbi') label = 'POWER BI';

                let preview = '';
                if(m.type==='image') preview = `<img src="/uploads/${m.filename}">`;
                else if(m.type==='video') preview = `<video preload="metadata"><source src="/uploads/${m.filename}#t=0.5"></video>`;
                else preview = `<div style="height:130px; background:#fff; display:flex; align-items:center; justify-content:center; border:1px solid #ddd; border-radius:8px; font-weight:bold; color:#7f8c8d; font-size:12px;">URL / BI</div>`;

                const html = `
                    <div class="media-item" data-id="${m.filename}">
                        <span class="media-tag tag-${m.type}">${label}</span>
                        ${preview}
                        <div class="expiry-info ${status.expired ? 'expiry-expired' : ''}">
                            ${status.expired ? 'üõë Expirou em' : '‚åõ Expira em'}:<br>${status.text}
                        </div>
                        <div class="btn-group">
                            <button class="edit-btn" onclick="editExpiry('${m.filename}')">üìÖ Adiar</button>
                            <button class="delete-btn" onclick="del('${m.filename}')">Remover</button>
                        </div>
                    </div>`;

                if (status.expired) historyContainer.innerHTML += html;
                else activeContainer.innerHTML += html;
            });
            new Sortable(activeContainer, { animation: 150 });
        }

        async function editExpiry(filename) {
            const newDate = prompt("Nova data de expira√ß√£o (Formato: AAAA-MM-DD HH:MM):");
            if (newDate) {
                await fetch(`/api/media/update-expiry/${playerId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename, newExpiry: newDate.replace(' ', 'T') })
                });
                load();
            }
        }

        async function saveOrder() {
            const orderedFilenames = Array.from(document.querySelectorAll('#mediaList .media-item')).map(el => el.dataset.id);
            await fetch(`/api/reorder/${playerId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ orderedFilenames })
            });
            alert("‚úÖ Playlist salva com sucesso!");
        }

        document.getElementById('uploadForm').onsubmit = async (e) => {
            e.preventDefault();
            await fetch(`/api/upload/${playerId}`, { method: 'POST', body: new FormData(e.target) });
            e.target.reset();
            load();
        };

        async function del(fname) {
            if(confirm("Deseja apagar permanentemente este conte√∫do?")) {
                await fetch(`/api/media/${playerId}/${encodeURIComponent(fname)}`, { method: 'DELETE' });
                load();
            }
        }
        load();
    </script>
</body>
</html>